<!DOCTYPE html><html lang="zh-cn"><head><title>React.PropTypes 源码分析 - One Piece Of Script</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><link rel="stylesheet" href="/modest.css"><link rel="stylesheet" href="/style.css"></head><body><div class="container"><div class="side-col"><div class="AuthorInfo"><img class="Avatar" src="https://avatars0.githubusercontent.com/u/17768382?v=3&amp;s=460"><h3>One Piece Of Script</h3><p>兴趣使然的前端工程师</p></div><ul class="linklist"><li><a href="/">home</a></li><li><a href="../">about</a></li></ul></div><div class="main-content page-content"><div class="page-header"><h1 class="title">React.PropTypes 源码分析</h1><ul class="page-meta"><li class="author">Tony Wang</li><li class="date">星期二, 2016 3月 15日 , 晚上 7:02</li></ul></div><article class="markdown-body"><p>该对象在ReactPropTypes模块中定义，包含了一系列对于 props 的验证方法。<br><a id="more"></a></p>
<hr>
<h2 id="模块使用示例"><a href="#模块使用示例" class="headerlink" title="模块使用示例"></a>模块使用示例</h2><p>以下引用了 React 源码中的注释部分，已翻译为中文。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Props = <span class="built_in">require</span>(<span class="string">'ReactPropTypes'</span>);</div><div class="line"><span class="keyword">var</span> MyArticle = React.createClass(&#123;</div><div class="line">    <span class="attr">propTypes</span>: &#123;</div><div class="line">        <span class="comment">// 模块名称，可选</span></div><div class="line">        description: Props.string,</div><div class="line"></div><div class="line">        <span class="comment">// 一个必须的枚举类型property</span></div><div class="line">        category: Props.oneOf([<span class="string">'News'</span>,<span class="string">'Photos'</span>]).isRequired,</div><div class="line"></div><div class="line">        <span class="comment">// 这个参数必须是Dialog的实例</span></div><div class="line">        dialog: Props.instanceOf(Dialog).isRequired</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; ... &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>更加正式的定义：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">type := array|bool|func|object|number|string|oneOf([...])|instanceOf(...)</div><div class="line">decl := ReactPropTypes.&#123;type&#125;(.isRequired)?</div></pre></td></tr></table></figure></p>
<p>每个声明都会产生一个具有相同特征的方法（这里应该理解为实现了同一个接口），所以这里可以自定义验证方法，例如：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> MyLink = React.createClass(&#123;</div><div class="line">    <span class="attr">propTypes</span>: &#123;</div><div class="line">        <span class="attr">href</span>: <span class="function"><span class="keyword">function</span>(<span class="params">props, propName, componentName</span>) </span>&#123;</div><div class="line">            <span class="keyword">var</span> propValue = props[propName];</div><div class="line">            <span class="keyword">if</span> (propValue != <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> propValue !== <span class="string">'string'</span> &amp;&amp;</div><div class="line">                !(propValue <span class="keyword">instanceof</span> URI)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">                    <span class="string">'Expected a string or an URI for '</span> + propName + <span class="string">' in '</span> + componentName);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">render</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;...&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>以下是ReactPropTypes定义的静态对象和方法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ReactPropTypes = &#123;</div><div class="line">    <span class="attr">array</span>: createPrimitiveTypeChecker(<span class="string">'array'</span>),</div><div class="line">    <span class="attr">bool</span>: createPrimitiveTypeChecker(<span class="string">'boolean'</span>),</div><div class="line">    <span class="attr">func</span>: createPrimitiveTypeChecker(<span class="string">'function'</span>),</div><div class="line">    <span class="attr">number</span>: createPrimitiveTypeChecker(<span class="string">'number'</span>),</div><div class="line">    <span class="attr">object</span>: createPrimitiveTypeChecker(<span class="string">'object'</span>),</div><div class="line">    <span class="attr">string</span>: createPrimitiveTypeChecker(<span class="string">'string'</span>),</div><div class="line"></div><div class="line">    <span class="attr">any</span>: createAnyTypeChecker(),</div><div class="line">    <span class="attr">arrayOf</span>: createArrayOfTypeChecker,</div><div class="line">    <span class="attr">element</span>: createElementTypeChecker(),</div><div class="line">    <span class="attr">instanceOf</span>: createInstanceTypeChecker,</div><div class="line">    <span class="attr">node</span>: createNodeChecker(),</div><div class="line">    <span class="attr">objectOf</span>: createObjectOfTypeChecker,</div><div class="line">    <span class="attr">oneOf</span>: createEnumTypeChecker,</div><div class="line">    <span class="attr">oneOfType</span>: createUnionTypeChecker,</div><div class="line">    <span class="attr">shape</span>: createShapeTypeChecker</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<h2 id="具体技术细节"><a href="#具体技术细节" class="headerlink" title="具体技术细节"></a>具体技术细节</h2><p>先总的来看看上面出现过的所有的方法的实现，这些方法都遵循一种特征：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createXXXChecker</span>(<span class="params">expected</span>) </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">props, propName, componentName, location, propFullName</span>) </span>&#123;...&#125;</div><div class="line">    <span class="keyword">return</span> createChainableTypeChecker(validate);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>那么这个createChainableTypeChecker方法做了些什么呢？<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createChainableTypeChecker</span>(<span class="params">validate</span>) </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkType</span>(<span class="params">isRequired, props, propName, componentName, location, propFullName</span>) </span>&#123;</div><div class="line">        componentName = componentName || ANONYMOUS;</div><div class="line">        propFullName = propFullName || propName;</div><div class="line">        <span class="keyword">if</span> (props[propName] == <span class="literal">null</span>) &#123;</div><div class="line">            <span class="keyword">var</span> locationName = ReactPropTypeLocationNames[location];</div><div class="line">            <span class="keyword">if</span> (isRequired) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Required '</span> + locationName + <span class="string">' `'</span> + propFullName + <span class="string">'` was not specified in '</span> + (<span class="string">'`'</span> + componentName + <span class="string">'`.'</span>));</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> validate(props, propName, componentName, location, propFullName);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> chainedCheckType = checkType.bind(<span class="literal">null</span>, <span class="literal">false</span>);</div><div class="line">    chainedCheckType.isRequired = checkType.bind(<span class="literal">null</span>, <span class="literal">true</span>);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> chainedCheckType;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法接受了一个函数作为输入，这个函数就是在createXXXChecker(expected)定义过得validate函数，其具有5个参数，是用来进一步验证输入值的。<br>该方法可返回一个函数对象，该函数对象自身是一个函数体，同时还带有一个isRequired的对象，这两个对象同时具有checkType的函数体，只是以isRequired参数作区分。这里不得不提到bind的使用方法。<br>很多人已经知道bind的第一个参数可以用来绑定作用域，该参数不能被重写，来创建一个指定作用域下的函数对象。但是bind在这里还有另外一个重要的功能，使一个函数拥有预设的初始参数，这些参数（如果有的话）作为bind()的第二个参数跟在this（或其他对象）后面，之后它们会被插入到目标函数的参数列表的开始位置，传递给绑定函数的参数会跟在它们的后面。（摘自MDN）<br>所以创建的函数依然满足validate的形式。checkType做的更多的是空检查和检查props是否isRequired。</p>
<p>接下来就是分别实现各种不同情况的验证了。<br>这里使用的时候只需要注意，基本类型不用传值，函数像instanceof、arrayof等都需要传递一个验证目标值。具体验证细节不再赘述了。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>该模块实现了props类型验证的辅助功能，createChainableTypeChecker就像是一层包装，将所有验证方法相同的细节都包装起来，在真正的验证方法运行前先执行了。这种实现非常优雅，充分做到了解耦和。</p>
</article></div></div></body></html>